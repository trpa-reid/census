---
title: "Using Census Data at TRPA"
author: "Tahoe Regional Planning Agency"
date: "2018"
output: 
  html_document:
    code_folding: hide
    highlight: tango
    number_sections: no
    theme: flatly
    toc: no
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: no
---

```{css, echo=FALSE}
div.sourceCode {
    overflow: hidden;
}
```
```{r, echo=FALSE}
htmltools::img(src = knitr::image_uri("H:/transportation monitoring/winter_summer_mode_travel_surveys/summer_2018/TRPA Survey/report/TRPALogo_COLOR_Transparent.png"),
               alt = 'logo', 
               style = 'position:absolute; top:0px; right:0px; padding:0px; max-width:20% ;')
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# {.tabset}

## Introduction

The U.S. Census Bureau collects and distributes data under a handful of different programs. Two of the more commonly used programs are the [Decennial Census](https://www.census.gov/history/www/programs/demographic/decennial_census.html) and the [American Community Survey (ACS)](https://www.census.gov/programs-surveys/acs/). The Decennial Census is a definite source of demographic data but only is collected every ten years; it includes a limited number of variables such as number of households and total population. The ACS is a program that provides data estimates on a one, three, and five year timeline; ACS data is collected more frequently but the data estimates have a margin of error that must considered because the data is taken from a small sample of the total population. The ACS includes many more variables compared to the Decennial Census that relate to transportation, income, and housing. Both the Decennial and ACS datasets have similiar data structures. Each row in both datasets include a particular variable and a number the indicates the total number of households or persons that characterize that variable.


```{r, warning=F, message=F, echo=F}
library(pacman)
p_load(tidycensus, tidyverse,leaflet, geojsonio, sf, tmap, tmaptools, DT, xfun)
census_api_key("680398dff0a2f4c566f10c95888da7f25e55147b")
options(tigris_use_cache = TRUE)

block_group<-geojson_read("https://opendata.arcgis.com/datasets/85a2e8e4bf994742a5855c1339517681_2.geojson", what="sp") %>% st_as_sf()

tract <- geojson_read("https://opendata.arcgis.com/datasets/85a2e8e4bf994742a5855c1339517681_3.geojson", what="sp") %>%
  st_as_sf()
```

### Summary of TRPA Census Data

#### Population
```{r, message=F, warning =F}
  nv_acs <- get_acs(geography = "tract", year=2016, 
                variables =  c("B01003_001"),
                state = "NV", county=c("Washoe", "Douglas")) %>%
  mutate(data_source="2016 ACS 2016 5-year Estimate")
ca_acs <- get_acs(geography = "tract", year=2016, 
                variables =  c("B01003_001"),
                state = "CA",county=c("El Dorado", "Placer")) %>%
  mutate(data_source="2016 ACS 2016 5-year Estimate")
ca_decen <- get_decennial(geography="tract", variables= c("P001001"), 
                          state= "CA", year= 2010, county=c("El Dorado", "Placer")) %>% 
  rename(estimate=value) %>% mutate(moe=0, data_source="2010 Decennial Census")
nv_decen <- get_decennial(geography="tract", variables= c("P001001"), 
                          state= "NV", year= 2010, county=c("Washoe", "Douglas")) %>% 
  rename(estimate=value) %>% mutate(moe=0, data_source="2010 Decennial Census")
all<- bind_rows(nv_decen,ca_decen, ca_acs, nv_acs) %>%
  left_join(data.frame(tract), by="GEOID") %>%
    filter(!is.na(STATEFP)) %>%
  group_by(variable, data_source) %>% summarise(total=sum(estimate), moe=sum(moe)) %>%
  mutate(variable_name = case_when ( variable== "P001001" ~ "Total Population",
                                    variable== "B01003_001" ~ "Total Population"),
         total=format(total, big.mark=",", scientific=FALSE),
         moe=format(moe, big.mark=",", scientific=FALSE)) %>%
  select(variable_name, variable, total,moe, data_source)
datatable(all, extensions = 'Buttons',
rownames=F,options=list(dom='t', 
          columnDefs = list(list(className = 'dt-center', targets = 0:1))), 
  class = 'cell-border stripe', 
colnames = c('Variable Name', 'Code', 'Total', 'Margin of Error','Data Source'))
```

#### Housing 
```{r, message=F, warning=F}
ca_decen <- get_decennial(geography="tract", variables= c("H001001"), 
                          state= "CA", year= 2010, county=c("El Dorado", "Placer")) %>% 
  rename(estimate=value) %>% mutate(moe=0, data_source="2010 Decennial Census")
nv_decen <- get_decennial(geography="tract", variables= c("H001001"), 
                          state= "NV", year= 2010, county=c("Washoe", "Douglas")) %>% 
  rename(estimate=value) %>% mutate(moe=0, data_source="2010 Decennial Census")
all<- bind_rows(nv_decen,ca_decen) %>%
  left_join(data.frame(tract), by="GEOID") %>%
    filter(!is.na(STATEFP)) %>%
  group_by(variable, data_source) %>% summarise(total=sum(estimate), moe=sum(moe)) %>%
  mutate(variable_name = case_when (variable== "H001001" ~ "Housing Units"),
         total=format(total, big.mark=",", scientific=FALSE),
         moe=format(moe, big.mark=",", scientific=FALSE)) %>%
  select(variable_name, variable, total,moe, data_source)
datatable(all, extensions = 'Buttons',
rownames=F,options=list(dom='t', 
          columnDefs = list(list(className = 'dt-center', targets = 0:1))), 
  class = 'cell-border stripe', 
colnames = c('Variable Name', 'Code', 'Total', 'Margin of Error','Data Source'))
```

#### Income
```{r, message=F, warning=F}
income <- c(`Less than $10,000`= "B19001_002",
                    `$10,000 to $14,999`= "B19001_003",
                    `$15,000 to $19,999` = "B19001_004",
                    `$20,000 to $24,999` = "B19001_005",
                    `$25,000 to $29,999` = "B19001_006",
                    `$30,000 to $34,999` = "B19001_007",
                    `$35,000 to $39,999` = "B19001_008", 
                    `$40,000 to $44,999` = "B19001_009",
                    `$45,000 to $49,999` = "B19001_010",
                    `$50,000 to $59,999` = "B19001_011", 
                    `$60,000 to $74,999` = "B19001_012",
                    `$75,000 to $99,999` = "B19001_013",
                    `$100,000 to $124,999` = "B19001_014", 
                    `$125,000 to $149,999` = "B19001_015",
                    `$150,000 to $199,999` = "B19001_016", 
                    `$200,000 or more` = "B19001_017")
  nv_acs <- get_acs(geography = "tract", year=2016, 
                variables =  income,
                state = "NV", county=c("Washoe", "Douglas"), summary_var = "B19001_001") %>%
  mutate(data_source="2016 ACS 2016 5-year Estimate")
ca_acs <- get_acs(geography = "tract", year=2016, 
                variables =  income,
                state = "CA",county=c("El Dorado", "Placer"), summary_var = "B19001_001") %>%
  mutate(data_source="2016 ACS 2016 5-year Estimate")
income1<-rownames_to_column(data.frame(income), "name") %>% select(name) %>% pull()
all<- bind_rows( ca_acs, nv_acs) %>%
  left_join(data.frame(tract), by="GEOID") %>%
    filter(!is.na(STATEFP)) %>%
  group_by(variable, data_source) %>% 
  summarise(total=sum(estimate), moe=sum(moe),total_estimate=sum(summary_est)) %>%
  mutate(total=format(total, big.mark=",", scientific=FALSE),
         moe=format(moe, big.mark=",", scientific=FALSE),
         variable_name="Household Income") %>%
  arrange(factor(variable, levels=income1)) %>%
  select(variable_name, variable, total,moe, total_estimate, data_source)
datatable(all, extensions = 'Buttons',
rownames=F,options=list(pageLength = 8, dom = 'Bfrtip',buttons = c('csv','pdf'),
          columnDefs = list(list(className = 'dt-center', targets = 0:1))), 
  class = 'cell-border stripe', 
colnames = c('Variable Name', 'Definition', 'Number of Households', 'Margin of Error','Total Households' ,'Data Source'))
```

#### School Enrollment
```{r, message=F, warning =F}
  nv_acs <- get_acs(geography = "tract", year=2016, 
                variables =  c("B14001_001"),
                state = "NV", county=c("Washoe", "Douglas")) %>%
  mutate(data_source="2016 ACS 2016 5-year Estimate")
ca_acs <- get_acs(geography = "tract", year=2016, 
                variables =  c("B14001_001"),
                state = "CA",county=c("El Dorado", "Placer")) %>%
  mutate(data_source="2016 ACS 2016 5-year Estimate")
all<- bind_rows(ca_acs, nv_acs) %>%
  left_join(data.frame(tract), by="GEOID") %>%
    filter(!is.na(STATEFP)) %>%
  group_by(variable, data_source) %>% summarise(total=sum(estimate), moe=sum(moe)) %>%
  mutate(variable_name = case_when ( variable== "B14001_001" ~ "School Enrollment"),
         total=format(total, big.mark=",", scientific=FALSE),
         moe=format(moe, big.mark=",", scientific=FALSE)) %>%
  select(variable_name, variable, total,moe, data_source)
datatable(all, extensions = 'Buttons',
rownames=F,options=list(dom='t', 
          columnDefs = list(list(className = 'dt-center', targets = 0:1))), 
  class = 'cell-border stripe', 
colnames = c('Variable Name', 'Code', 'Total', 'Margin of Error','Data Source'))
```

#### Travel Mode to Work
```{r, message=F, warning=F }
work_transport <- c(Drive= "B08301_002",
                    Walk= "B08301_019",
                    Bike = "B08301_018",
                    `Public Transport` = "B08301_010",
                    `Work from Home` = "B08301_021",
                    Other = "B08301_020",
                    Motorcycle = "B08301_017", 
                    Taxi = "B08301_016")
  nv <- get_acs(geography = "tract", year=2016, 
                variables =  work_transport, 
                state = "NV", geometry = TRUE, summary_var = "B08301_001" )
  ca <- get_acs(geography = "tract", year=2016, 
                variables = work_transport, summary_var = "B08301_001", 
                state = "CA", geometry= TRUE)
   all<- rbind(nv, ca) %>%
    left_join(data.frame(tract), by="GEOID") %>%
    filter(!is.na(STATEFP)) %>%
    dplyr::select(GEOID, NAME.x, variable, estimate, moe, summary_est, summary_moe, County) %>%
    data.frame() %>% select(-geometry.x) %>%
    mutate(source="2016 ACS 2016 5-year Estimate") %>%
    group_by(variable,source ) %>% 
    summarise(number= sum(estimate), total=sum(summary_est), moe=sum(moe)) %>%         
    mutate(total=format(total, big.mark=",", scientific=FALSE),
           number=format(number, big.mark=",", scientific=FALSE),
         moe=format(moe, big.mark=",", scientific=FALSE)) %>%
  select(variable, number, moe,total, source)
  datatable(all, extensions = 'Buttons',
rownames=F,options=list(dom='t', 
          columnDefs = list(list(className = 'dt-center', targets = 0:1))), 
  class = 'cell-border stripe', 
colnames= c ('Variable Name', 'Estimate', 'Margin of Error', 'Total Households','Data Source'))
```

#### Rental Costs
```{r, message=F, warning=F }
rent <- c(`No bedroom`= "B25068_002",
          `No bedroom w/ cash rent`= "B25068_003",
          `No bedroom - Less than $300`= "B25068_004",
                    `No bedroom - $300 to $499`= "B25068_005",
                    `No bedroom - $500 to $749` = "B25068_006",
                    `No bedroom - $750 to $999` = "B25068_007",
                    `No bedroom - $1,000 to $1,499` = "B25068_008",
                    `No bedroom - $1,500 or more` = "B25068_009",
                    `No bedroom - no cash rent` = "B25068_010",
                    `1 bedroom` = "B25068_011",
                    `1 bedroom w/ cash rent` = "B25068_012",
                    `1 bedroom - Less than $300` = "B25068_013", 
                    `1 bedroom - $300 to $499`= "B25068_014",
                    `1 bedroom - $500 to $749` = "B25068_015",
                    `1 bedroom - $750 to $999` = "B25068_016",
                    `1 bedroom - $1,000 to $1,499` = "B25068_017",
                    `1 bedroom - $1,500 or more` = "B25068_018",
                    `1 bedroom - no cash rent` = "B25068_019",
                    `2 bedroom` = "B25068_020",
                    `2 bedroom w/ cash rent` = "B25068_021",
                    `2 bedroom - Less than $300` = "B25068_022", 
                    `2 bedroom - $300 to $499`= "B25068_023",
                    `2 bedroom - $500 to $749` = "B25068_024",
                    `2 bedroom - $750 to $999` = "B25068_025",
                    `2 bedroom - $1,000 to $1,499` = "B25068_026",
                    `2 bedroom - $1,500 or more` = "B25068_027",
                    `2 bedroom - no cash rent` = "B25068_028",
                    `3 bedroom or more` = "B25068_029",
                    `3 bedroom or more w/ cash rent` = "B25068_030",
                    `3 or more bedroom - Less than $300` = "B25068_031", 
                    `3 or more bedroom - $300 to $499`= "B25068_032",
                    `3 or more bedroom - $500 to $749` = "B25068_033",
                    `3 or more bedroom - $750 to $999` = "B25068_034",
                    `3 or more bedroom - $1,000 to $1,499` = "B25068_035",
                    `3 or more bedroom - $1,500 or more` = "B25068_036",
                    `3 or more bedroom - no cash rent` = "B25068_037")
  nv <- get_acs(geography = "tract", year=2016, 
                variables = rent, summary_var = "B25068_001",
                state = "NV", geometry = TRUE)
  ca <- get_acs(geography = "tract", year=2016, 
                variables = rent, summary_var = "B25068_001", 
                state = "CA", geometry= TRUE)
   all<- rbind(nv, ca) %>%
    left_join(data.frame(tract), by="GEOID") %>%
    filter(!is.na(STATEFP)) %>%
    dplyr::select(GEOID, NAME.x, variable, estimate, moe, County, summary_est) %>%
    data.frame() %>% select(-geometry.x) %>%
    mutate(source="2016 ACS 2016 5-year Estimate") %>%
    group_by(variable,source) %>% 
    summarise(number= sum(estimate), moe=sum(moe), summary_est=sum(summary_est)) %>%         
    mutate(number=format(number, big.mark=",", scientific=FALSE),
         moe=format(moe, big.mark=",", scientific=FALSE)) %>%
  select(variable, number, moe, summary_est, source)
  datatable(all, extensions = 'Buttons',
rownames=F,options=list(pageLength = 8, dom = 'Bfrtip',buttons = c('csv','pdf'),
          columnDefs = list(list(className = 'dt-center', targets = 0:1))), 
  class = 'cell-border stripe', 
colnames= c ('Variable Name', 'Estimate', 'Margin of Error', 'Total Estimate', 'Data Source'))
```
#### Household Size
```{r, message=F, warning=F}
hhsize<- c(`Household Size - 1 Person`="H013002",
           `Household Size - 2 Person`= "H013003",
           `Household Size - 3 Person`="H013004",
            `Household Size - 4 Person`= "H013005",
            `Household Size - 5 Person`= "H013006",
           `Household Size - 6 Person` = "H013007", 
           `Household Size - 7 Person or More` = "H013008")
  nv <- get_decennial(geography = "tract", year=2010, 
                variables =  hhsize, county=c("Washoe", "Douglas"),
                state = "NV", geometry = F, summary_var = "H013001" )
  ca <- get_decennial(geography = "tract", year=2010, county=c("El Dorado", "Placer"),
                variables = hhsize, summary_var = "H013001", 
                state = "CA", geometry= F)
  all<- bind_rows(nv, ca) %>%
    left_join(data.frame(tract), by="GEOID") %>%
    filter(!is.na(STATEFP)) %>%
    dplyr::select(GEOID, NAME.x, variable, value, County, summary_value) %>%
    data.frame() %>%
    mutate(data_source="2010 Decennial Census") %>%
    group_by(variable, data_source) %>% summarise(number=sum(value), total=sum(summary_value)) %>%
   mutate( total=format(total, big.mark=",", scientific=FALSE),
           number=format(number, big.mark=",", scientific=FALSE)) %>%
  select(variable, number, total, data_source)
  
  datatable(all, extensions = 'Buttons',
rownames=F,options=list(dom='t', 
          columnDefs = list(list(className = 'dt-center', targets = 0:1))), 
  class = 'cell-border stripe', colnames = c('Variable Name', 'Count', 'Total','Data Source'))
```

#### Demographics: Race

```{r, warning=F, message=F}
race<- c(`White alone`="P003002",
           `Black or African American alone`= "P003003",
           `American Indian and Alaska Native alone`="P003004",
            `Asian alone`= "P003005",
            `Native Hawaiian and Other Pacific Islander alone`= "P003006",
           `Some Other Race alone` = "P003007", 
           `Two or More Races` = "P003008")
  nv <- get_decennial(geography = "tract", year=2010, 
                variables =  race, county=c("Washoe", "Douglas"),
                state = "NV", geometry = F, summary_var="P003001" )
  ca <- get_decennial(geography = "tract", year=2010, county=c("El Dorado", "Placer"),
                variables = race, summary_var="P003001", 
                state = "CA", geometry= F)
  
all<- bind_rows(nv, ca) %>%
    left_join(data.frame(tract), by="GEOID") %>%
    filter(!is.na(STATEFP)) %>%
    group_by(variable) %>% summarise(value=sum(value), total=sum(summary_value)) %>%
    mutate(source="2010 Decennial Census")

datatable(all, extensions = 'Buttons',
rownames=F,options=list(dom='t', 
          columnDefs = list(list(className = 'dt-center', targets = 0:1))), 
  class = 'cell-border stripe', colnames = c('Variable Name', 'Count', 'Total','Data Source'))
```

## Browse all ACS Variables

Search through the list below to determine which variable(s) you want to analyze. You can download all of the variables 

```{r, warning= F, message=F}
acs_var <- load_variables(2016, "acs5", cache = TRUE)

datatable(acs_var, extensions = 'Buttons',
rownames=F,options=list(pageLength = 15, dom = 'Bfrtip',buttons = c('csv','pdf'), 
          columnDefs = list(list(className = 'dt-center', targets = 0:1))), 
  class = 'cell-border stripe')
```

## Browse all Decennial Variables

Search through the list below to determine which variable(s) you want to analyze.

```{r, warning= F, message=F}
decen_var <- load_variables(2010, "sf1", cache = TRUE)

datatable(decen_var, extensions = 'Buttons',
rownames=F,options=list(pageLength = 15, dom = 'Bfrtip',buttons = c('csv','pdf'), 
          columnDefs = list(list(className = 'dt-center', targets = 0:1))), 
  class = 'cell-border stripe')
```

## TRPA Census Tracts
```{r, message=F, warning=F}
tmap_mode("view")
popup1 <- paste0("<strong>GEOID: </strong>", 
                     tract$GEOID) 
leaflet(tract) %>% 
  addPolygons(popup=popup1,color="white", opacity=1,fillColor = "#bc0114",
                   weight=1, fillOpacity = .5,
              highlightOptions = highlightOptions(
                color = "#F9D2D2", opacity = 1, weight = 2, fillOpacity = 1,
                bringToFront = TRUE, sendToBack = TRUE)) %>% 
  addProviderTiles("Wikimedia") %>% 
  setView(-120.020493,39.041803,zoom=10)

#tm_shape(tract)+ tm_polygons() + tm_view(set.zoom.limits = c(9,16))
```
[Download the Data Tahoe Open Data](http://data-trpa.opendata.arcgis.com/datasets/85a2e8e4bf994742a5855c1339517681_3)
```{r, message=F, warning=F}
datatable(tract %>% data.frame() %>% select(GEOID, County) %>% mutate(Note="TRPA Census Tracts"), 
          extensions = 'Buttons',
rownames=F,options=list(pageLength = 10, dom = 'Bfrtip',buttons = c('csv','pdf'), 
          columnDefs = list(list(className = 'dt-center', targets = 0:1))), 
  class = 'cell-border stripe')

```

## TRPA Block Groups
```{r, message=F, warning=F}
#tmap_mode("view")
#tm_shape(block_group)+ tm_polygons()
popup1 <- paste0("<strong>GEOID: </strong>", 
                     block_group$GEOID) 
leaflet(block_group) %>% 
  addPolygons(popup=popup1,color="white", opacity=1,fillColor = "#bc0114",
                   weight=1, fillOpacity = .5,
              highlightOptions = highlightOptions(
                color = "#F9D2D2", opacity = 1, weight = 2, fillOpacity = 1,
                bringToFront = TRUE, sendToBack = TRUE)) %>% 
  addProviderTiles("Wikimedia") %>% 
  setView(-120.020493,39.041803,zoom=10)
```
[Download the Data Tahoe Open Data](http://data-trpa.opendata.arcgis.com/datasets/85a2e8e4bf994742a5855c1339517681_2)
```{r, message=F, warning=F}
datatable(block_group %>% data.frame() %>% select(GEOID, COUNTYFP) %>% mutate(Note="TRPA Block Groups"), 
          extensions = 'Buttons',
rownames=F,options=list(pageLength = 10, dom = 'Bfrtip',buttons = c('csv','pdf'), 
          columnDefs = list(list(className = 'dt-center', targets = 0:1))), 
  class = 'cell-border stripe')
```

 

